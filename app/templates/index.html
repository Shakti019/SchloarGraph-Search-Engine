<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScholarGraph AI - Domain Aware Retrieval</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Blue wave background for homepage */
        .home-container {
            background: linear-gradient(180deg, #e8f4fc 0%, #d0e8f7 30%, #b8dcf0 50%, #ffffff 100%) !important;
            position: relative;
            overflow: hidden;
        }
        .home-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(66, 133, 244, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(26, 115, 232, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(66, 133, 244, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .home-container > * {
            position: relative;
            z-index: 1;
        }
        /* Wave SVG at bottom */
        .wave-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 150px;
            z-index: 0;
        }
        
        /* Mobile-first inline styles for homepage */
        @media (max-width: 768px) {
            .home-container {
                padding: 20px 15px !important;
                min-height: 100vh;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
            }
            .home-logo {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                text-align: center !important;
                width: 100% !important;
                font-size: 24px !important;
                margin-bottom: 20px !important;
            }
            .home-logo .logo-icon {
                display: block !important;
                margin: 0 auto 10px auto !important;
                font-size: 40px !important;
                text-align: center !important;
            }
            .home-logo .logo-text {
                display: block !important;
                width: 100% !important;
                text-align: center !important;
                font-size: 24px !important;
                line-height: 1.3 !important;
            }
            .home-search {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 10px !important;
                box-sizing: border-box !important;
            }
            .home-search form {
                width: 100% !important;
            }
            .search-input.home-input {
                width: 100% !important;
                font-size: 16px !important;
                box-sizing: border-box !important;
            }
            .home-subtitle {
                font-size: 11px !important;
                text-align: center !important;
                padding: 0 10px !important;
                line-height: 1.4 !important;
            }
            .wave-bg {
                height: 80px;
            }
        }
    </style>
</head>
<body>

    {% if not results %}
    <!-- HOME PAGE LAYOUT -->
    <div class="home-container fade-in">
        <!-- Wave SVG Background -->
        <svg class="wave-bg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" preserveAspectRatio="none">
            <path fill="#d0e8f7" fill-opacity="0.5" d="M0,192L48,176C96,160,192,128,288,133.3C384,139,480,181,576,197.3C672,213,768,203,864,170.7C960,139,1056,85,1152,74.7C1248,64,1344,96,1392,112L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
            <path fill="#b8dcf0" fill-opacity="0.4" d="M0,256L48,240C96,224,192,192,288,181.3C384,171,480,181,576,186.7C672,192,768,192,864,176C960,160,1056,128,1152,128C1248,128,1344,160,1392,176L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
            <path fill="#a8d4ec" fill-opacity="0.3" d="M0,288L48,277.3C96,267,192,245,288,234.7C384,224,480,224,576,234.7C672,245,768,267,864,261.3C960,256,1056,224,1152,213.3C1248,203,1344,213,1392,218.7L1440,224L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
        </svg>
        
        <div class="home-logo">
            <i class="fas fa-project-diagram logo-icon"></i>
            <span class="logo-text">Scholar<span>Graph</span> AI</span>
        </div>
        <div class="home-search">
            <form action="/search" method="get" style="position: relative;">
                <i class="fas fa-search search-icon-home"></i>
                <input type="text" name="q" class="search-input home-input" placeholder="Search for research papers (e.g., 'RL for robotics')..." required autofocus>
            </form>
        </div>
        <div class="home-subtitle">
            <i class="fas fa-network-wired"></i> Graph-Optimized Master Routing for Domain-Aware Scholarly AI Retrieval
        </div>
    </div>

    {% else %}
    <!-- RESULTS PAGE LAYOUT -->
    <header class="header fade-in-down">
        <a href="/" class="logo" onclick="window.location.href='/'; return false;"><i class="fas fa-project-diagram" style="color: #1a0dab; margin-right: 10px;"></i>Scholar<span>Graph</span></a>
        <form action="/search" method="get" class="search-form">
            <input type="text" name="q" class="search-input" value="{{ query }}" required>
            <button type="submit" class="search-btn"><i class="fas fa-search"></i></button>
        </form>
        <a href="/" class="home-btn" title="Go to Home"><i class="fas fa-home"></i></a>
    </header>

    <div class="container fade-in">
        <!-- Left Column: Results (Scrollable) -->
        <div class="results-col">
            <div style="margin-bottom: 20px; color: #70757a; font-size: 14px;">
                Found {{ results|length }} results in {{ latency }} seconds
            </div>

            {% if not results %}
                <p>No results found. Try a different query.</p>
            {% endif %}

            {% for paper in results %}
            <div class="result-item" data-collection="{{ paper.collection }}">
                <div class="result-header">
                    <a href="{{ paper.doi if paper.doi else paper.url }}" target="_blank" class="result-title">{{ paper.title }}</a>
                </div>

                <div class="result-meta">
                    <span class="meta-source">{{ paper.display_collection }}</span>
                    <span class="meta-divider">•</span>
                    <span class="meta-authors">
                        {% if paper.authors %}
                            {{ paper.authors[0].name }}{% if paper.authors|length > 1 %} et al.{% endif %}
                        {% else %}
                            Unknown Author
                        {% endif %}
                    </span>
                    <span class="meta-divider">•</span>
                    <span class="meta-venue">{{ paper.venue or 'Preprint' }}</span>
                    <span class="meta-divider">•</span>
                    <span class="meta-year">{{ paper.year }}</span>
                </div>

                {% if paper.abstract %}
                <div class="result-abstract">
                    {{ paper.abstract[:300] }}{% if paper.abstract|length > 300 %}...{% endif %}
                </div>
                {% endif %}

                <div class="result-footer">
                    <div class="result-actions">
                        <a href="/analysis/{{ paper.collection }}/{{ paper.id }}" class="action-btn analyze-btn">
                            <i class="fas fa-magic"></i> AI Analysis
                        </a>
                        <a href="#" class="action-link">Cite ({{ paper.citations }})</a>
                        {% if paper.doi %}
                        <a href="{{ paper.doi }}" target="_blank" class="action-link">Source</a>
                        {% endif %}
                    </div>
                    {% if paper.is_oa %}
                    <div class="oa-badge"><i class="fas fa-lock-open"></i> Open Access</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            <!-- Pagination -->
            <div class="pagination" style="margin-top: 30px; display: flex; justify-content: center; gap: 10px;">
                {% if page > 1 %}
                    <a href="/search?q={{ query }}&page={{ page - 1 }}" class="pagination-btn">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                {% endif %}
                
                <span style="padding: 8px 12px; color: #5f6368;">Page {{ page }}</span>

                {% if has_next %}
                    <a href="/search?q={{ query }}&page={{ page + 1 }}" class="pagination-btn">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Routing Stats (Fixed) -->
        <div class="stats-col">
            <div class="stats-box">
                <h4><i class="fas fa-project-diagram"></i> Routing Intelligence</h4>
                
                <div class="stats-summary">
                    <div class="stat-metric">
                        <span class="metric-label">Latency</span>
                        <span class="metric-value">{{ latency }}s</span>
                    </div>
                    <div class="stat-metric">
                        <span class="metric-label">Top Domain</span>
                        <span class="metric-value">{{ routed_to[0].display_name if routed_to else 'N/A' }}</span>
                    </div>
                    <div class="stat-metric">
                        <span class="metric-label">Confidence</span>
                        <span class="metric-value" style="color: #137333;">High</span>
                    </div>
                </div>

                <p class="stats-desc">
                    The <strong>Master Router</strong> analyzed your query using semantic similarity and graph weights to select the optimal knowledge domains.
                </p>
                
                <div class="routes-list">
                    {% for route in routed_to %}
                    <div class="route-item">
                        <div class="route-header">
                            <span class="route-name">{{ route.display_name }}</span>
                            <span class="route-weight">Weight: {{ "%.2f"|format(route.graph_w) }}</span>
                        </div>
                        <div class="weight-bar-bg">
                            <div class="weight-bar-fill" style="width: {{ (route.graph_w / 5 * 100) if route.graph_w < 5 else 100 }}%;"></div>
                        </div>
                        <div class="route-details">
                            <span><i class="fas fa-bullseye"></i> Score: {{ "%.3f"|format(route.score) }}</span>
                            <span><i class="fas fa-network-wired"></i> Active Nodes</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="graph-status">
                    <i class="fas fa-check-circle"></i> Knowledge Graph Active
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Skeleton Loading View -->
    <div class="skeleton-view" id="skeletonView">
        <div class="skeleton-header">
            <div class="skeleton-logo"></div>
            <div class="skeleton-search-bar"></div>
        </div>
        <div class="skeleton-container">
            <div class="skeleton-results-col">
                <!-- Repeat skeleton items -->
                {% for i in range(5) %}
                <div class="skeleton-result-item">
                    <div class="skeleton-line sk-title"></div>
                    <div class="skeleton-line sk-meta"></div>
                    <div class="skeleton-line sk-text"></div>
                    <div class="skeleton-line sk-text"></div>
                    <div class="skeleton-line sk-text-short"></div>
                </div>
                {% endfor %}
            </div>
            <div class="skeleton-stats-col">
                <div class="skeleton-line sk-box"></div>
            </div>
        </div>
    </div>

    <script>
        // Show skeleton view when forms are submitted
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                document.getElementById('skeletonView').style.display = 'block';
                // Hide main content if visible
                const homeContainer = document.querySelector('.home-container');
                if (homeContainer) homeContainer.style.display = 'none';
                
                const resultsContainer = document.querySelector('.container');
                if (resultsContainer) resultsContainer.style.display = 'none';

                const header = document.querySelector('.header');
                if (header) header.style.display = 'none';
            });
        });

        // --- Search Suggestions & Routing Preview ---
        const searchInputs = document.querySelectorAll('.search-input');
        
        searchInputs.forEach(input => {
            // Create suggestion box
            const suggestionBox = document.createElement('div');
            suggestionBox.className = 'suggestion-box';
            suggestionBox.style.display = 'none';
            input.parentNode.appendChild(suggestionBox);

            let timeout = null;

            input.addEventListener('input', function() {
                const query = this.value;
                
                if (query.length < 2) {
                    suggestionBox.style.display = 'none';
                    return;
                }

                // Debounce
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    fetch(`/suggest?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (!data) return;

                            let html = '';
                            
                            // 1. Routing Prediction
                            html += `
                                <div class="suggestion-header">
                                    <i class="fas fa-bolt" style="color: #fbbc04;"></i> 
                                    Routing to: <strong>${data.predicted_domain}</strong>
                                    <span style="font-size: 11px; color: #006621; margin-left: 5px;">(Weight: ${data.graph_weight.toFixed(2)})</span>
                                </div>
                            `;

                            // 2. Keyword Completions
                            if (data.completions.length > 0) {
                                data.completions.forEach(term => {
                                    html += `<div class="suggestion-item" onclick="selectSuggestion('${term}')"><i class="fas fa-search" style="color: #9aa0a6; margin-right: 10px; font-size: 12px;"></i> ${term}</div>`;
                                });
                            }

                            suggestionBox.innerHTML = html;
                            suggestionBox.style.display = 'block';
                        });
                }, 300);
            });

            // Hide on blur (delayed to allow click)
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestionBox.style.display = 'none';
                }, 200);
            });
        });

        function selectSuggestion(term) {
            const inputs = document.querySelectorAll('.search-input');
            inputs.forEach(i => i.value = term);
            document.querySelector('form').submit();
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.result-title, .analyze-btn').forEach(el => {
                el.addEventListener('click', function(e) {
                    const item = this.closest('.result-item');
                    const collection = item.getAttribute('data-collection');
                    if (collection) {
                        fetch('/feedback', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ collection: collection, reward: 0.1 }),
                        }).catch(console.error);
                    }
                });
            });
        });

        // Handle browser back/forward button - force reload to get fresh page
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // Page was restored from bfcache, reload it
                window.location.reload();
            }
        });

        // Also handle popstate for SPA-like behavior
        window.addEventListener('popstate', function(event) {
            window.location.reload();
        });
    </script>

</body>
</html>
